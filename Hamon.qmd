---
title: "Hamon"
format: html
editor: visual
---

The link to my GitHub repository is : https://github.com/hamoco20/eval-grades.git

```{r}
here::i_am("final graded lab.Rproj")
library(here)
library(ggplot2)
library(vroom)
library(dplyr)
library(tidyr)
library(lubridate)
```

# Introduction

## Study Organisation

Question 1

```{r}
courses <- vroom(here("data", "courses.csv"))
```

Question 2

```{r}
courses |>
  rename(
    `course name` = course,
    identifier = course_id,
    `number of exams` = nb_grades
  ) |>
  arrange(`course name`) |>
  knitr::kable()
```

## Students

Question 3

```{r}
students <- vroom(
  here("data", "students.csv"),
  col_types = cols(
    id = col_integer(),
    group = col_integer(),
    birth_date = col_date(),
    sex = col_factor()
  )
)
students
```

## Grades

Question 4

```{r}
grades <- vroom(
  here("data", "grades.csv"),
  delim = ";",
  na = "$",
  col_types = cols(
    id = col_integer(),
    course_id = col_integer(),
    grade = col_double()
  )
)
grades
```

# Student population analysis

Question 5

```{r}
students |>
  count(group) |>
  arrange(group) |>
  ggplot(aes(x = group, y=n)) +
  geom_col()
```

Question 6

```{r}
students |>
  count(group, sex) |>
  arrange(group) |>
  ggplot(aes(x = factor(group), y = n, fill = sex)) +
  geom_col() +
  labs(
    title = "gender balance in groups"
  )
```

Question 7

```{r}
students <- students |>
  mutate(
    age = time_length(today() - birth_date, unit = "year")
  )

students <- students |>
  mutate(
    age = round(age)
  )

ggplot(students, aes(x = age)) +
  geom_histogram(binwidth = 1, fill = "skyblue", color="white") +
  labs(
    title = "distribution of students' ages",
    x = "age in years",
    y = "nb of students"
  )
```

Question 8

```{r}
students |>
  group_by(group) |>
  summarize(
    median_age = median(age)
    ) |>
  arrange(group) |>
  knitr::kable()
```

Question 9

```{r}
students |>
  group_by(group) |>
  slice_max(order_by = age, n=1, with_ties = FALSE) |>
  select(id, sex, age, group) |>                  
  arrange(desc(age)) |>
  knitr::kable() 
```

Question 10 
The data set contains `r sum(!is.na(grades$grade))` grades.

Question 11
```{r}
courses |>
  filter(course == "Divine Philosophy and Ethics") |>
  pull(course_id)

divine_grades <- grades |>
  filter(course_id == 1) |>
  inner_join(students, by = "id")

divine_grades |>
  group_by(group) |>
  summarize(avg_grade = mean(grade, na.rm = TRUE)) |>
  arrange(group) |>
  ggplot(aes(x = factor(group), y = avg_grade)) +
  geom_col(fill = "skyblue") +
   labs(
    title = "average grade in divine philosophy and ethics by group")
```

Question 12
```{r}
grades |>
  filter(!is.na(grade)) |>                
  inner_join(courses |> select(course_id, module), by = "course_id") |>  
  mutate(module = factor(module)) |>
           ggplot(aes(x = grade, fill = module)) +
  geom_density(alpha = 0.4) +              
  labs(
    title = "distribution of grades by module",
    x = "grade",
    y = "density",
    fill = "module"
  ) 
```
Module 2 seems to have the highest grades overall because of its right-wing position and an average above 10 compared to the the module 1 where grades seems more heterogenous but lower on average. So, module 1 seems to be more difficult than 2 and 3.

# Attendance analysis

Question 13
```{r}
grades_per_student <- grades |>
  filter(!is.na(grade)) |>         
  group_by(id) |>
  summarize(nb_grades = n(), .groups = "drop") |>
  inner_join(students, by = "id") 

grades_per_student |>
  slice_head(n = 10) |>
  knitr::kable(caption = "nb of grades per student (Sample)") 

grades_per_student |>
  summarize(
    min_grades = min(nb_grades),
    max_grades = max(nb_grades),
    avg_grades = round(mean(nb_grades), 2),
    median_grades = median(nb_grades)
  ) |>
  knitr::kable()
```

Question 14
```{r}
ggplot(grades_per_student, aes(x = nb_grades, fill = sex)) +
  geom_density(alpha = 0.4) +
  labs(
    title = "density of number of grades by sex",
    x = "nb of grades",
    y = "density",
    fill = "sex"
  ) 
```
Attendance between the 2 genders seems quite similar as the 2 dentsity curves are close with a slightly higher density for girls at the left wing, maybe pointing out that girls tend to have a less irregular attendance.

Question 15
```{r}
courses |>
  filter(course == "Astronomy and Cosmology") |>
  pull(course_id)

astro_grades_per_student <- grades |>
  filter(course_id == 7, !is.na(grade)) |> 
  group_by(id) |>
  summarize(nb_grades_astro = n(), .groups = "drop") |>
  inner_join(students |> select(id, group), by = "id")
  
astro_grades_per_student |>
  slice_head(n = 10) |>
  knitr::kable(caption = "nb of grades in Astronomy and Cosmology per student (Sample)")
```
Question 16
```{r}
astro_grades_per_student |>
  count(nb_grades_astro, name = "n_students") |>
  arrange(nb_grades_astro) |>
  ggplot(aes(x = factor(nb_grades_astro), y = n_students)) +
  geom_col(fill = "lightyellow", color="white") +
  labs(
    title = "distribution of nb of grades in Astronomy and Cosmology",
    x = "nb of grades",
    y = "nb of students"
  )
```
Question 17
```{r}
ggplot(astro_grades_per_student, aes(x = factor(group), y = nb_grades_astro)) +
  geom_jitter(width = 0.1, height = 0, alpha = 0.5) +
  stat_summary(fun = mean, geom = "point", color = "red", size = 2) +
  labs(
    title = "nb of grades per student in Astronomy and Cosmology by group",
    x = "group",
    y = "nb of grades"
  )

```
It seems like the maximum number of grades per group is 10, the heterogeneity of number of grades observed don't seem to depend on the groups.

Question 18
```{r}
astro_grades_per_student <- grades |>
  filter(course_id == courses$course_id[courses$course == "Astronomy and Cosmology"], 
         !is.na(grade)) |>
  group_by(id) |>
  summarize(nb_grades_astro = n(), .groups = "drop") |>
  inner_join(students |> select(id, group, sex), by = "id") 


ggplot(astro_grades_per_student, aes(x = factor(group), y = nb_grades_astro, fill = sex)) +
  geom_boxplot(position = position_dodge(width = 0.8)) +
  labs(
    title = "Number of Grades in Astronomy and Cosmology by Group and Sex",
    x = "Group",
    y = "Number of Grades",
    fill = "Sex"
)
```
Most students have the maximum number of grades.

# Grade analysis

Question 19
```{r}
grades_named <- grades |>
  left_join(courses |> select(course_id, course), by = "course_id")

avg_grades <- grades_named |>
  group_by(id, course) |>
  summarise(avg_grade = mean(grade, na.rm = TRUE), .groups = "drop")

avg_grades <- avg_grades |>
  left_join(students |> select(id, group), by = "id")

pivoted_df <- avg_grades |>
  pivot_wider(
    names_from = course,
    values_from = avg_grade
  )

pivoted_df |>
  select(id, group, `Architecture and Sculpture`, `Astronomy and Cosmology`, `Combat and Martial Arts of the Gods`) |>
  slice(1:5) |>
  knitr::kable(caption = "Extract of average grades per student")

pivoted_df
```
Question 20
```{r}
pivoted_df |>
  select(id, `Divine Philosophy and Ethics`, `Architecture and Sculpture`) |>
  drop_na() |>
  ggplot(aes(x = `Architecture and Sculpture`, y = `Divine Philosophy and Ethics`)) +
  geom_point(color = "steelblue", size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", color = "red", se = TRUE) +
  labs(
    title = "Relationship between Architecture and Sculpture vs Divine Philosophy and Ethics",
    x = "avg grade in Architecture and Sculpture",
    y = "avg grade in Divine Philosophy and Ethics"
  )
```
There appears to be a positive correlation between the 2 averages.

Question 21
```{r}
pivoted_df |>
  select(id, group, `Rhetoric and Persuasion`, `Combat and Martial Arts of the Gods`) %>%
  drop_na() |>  
  group_by(group) |>
  summarise(
    correlation = cor(`Rhetoric and Persuasion`, `Combat and Martial Arts of the Gods`),
    .groups = "drop"
  ) |>
  arrange(group) |>
  knitr::kable()
```

Question 22
```{r}
pivoted_df |>
  select(id, group, `Rhetoric and Persuasion`, `Combat and Martial Arts of the Gods`) %>%
  drop_na() |>  
  group_by(group) |>
  summarise(
    correlation = cor(`Rhetoric and Persuasion`, `Combat and Martial Arts of the Gods`),
    .groups = "drop"
  ) |>
  slice_max(order_by = abs(correlation)) %>%
  pull(group)
```


```{r}
pivoted_df |>
  filter(group == 4) |>
  select(id, `Rhetoric and Persuasion`, `Combat and Martial Arts of the Gods`) |>
  drop_na() |>
  ggplot(aes(x = `Combat and Martial Arts of the Gods`, y = `Rhetoric and Persuasion`)) +
  geom_point(color = "blue", size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", color = "red", se = TRUE) +
  labs(
    title = ("Rhetoric vs Combat & Martial Arts"),
    x = "Average grade in Combat and Martial Arts of the Gods",
    y = "Average grade in Rhetoric and Persuasion"
  ) +
  theme_minimal(base_size = 10)
```
Indeed, for the student with the most correlated averages between the 2 courses, we observe a much clearer positive relationship between the 2 averages.

Question 23
```{r}
pivoted_df |>
  left_join(students |>  select(id, sex), by = "id") |>
  rowwise() |>
  mutate(
    final_grade = mean(c_across(`Architecture and Sculpture`:`Rhetoric and Persuasion`), na.rm = TRUE)
  ) |>
  ungroup() |>
  select(id, group, sex, final_grade) |>
  arrange(desc(final_grade)) |>
  slice(1:5) |>
  knitr::kable(caption = "top 5 students by final grade")
```

